        <!DOCTYPE html>
        <html>
        <head>
                <meta charset="utf-8">
        <title>Cursor class / mongo_dart Library / Dart Documentation</title>
        <link rel="stylesheet" type="text/css"
            href="../styles.css">
        <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet" type="text/css">
        <link rel="shortcut icon" href="../favicon.ico">
        
        </head>
        <body data-library="mongo_dart" data-type="Cursor">
        <div class="page">
        <div class="header">
          <a href="../index.html"><div class="logo"></div></a>
          <a href="../index.html">Dart Documentation</a>
         &rsaquo; <a href="../mongo_dart.html">mongo_dart</a> &rsaquo; <a href="../mongo_dart/Cursor.html">Cursor</a>        <div id="search-box">
          <input type="search" name="q" id="q" autocomplete="off"
              class="search-input" placeholder="Search API">
        </div>
        
      </div>
      <div class="drop-down" id="drop-down"></div>
      
        <div class="nav">
        
<h2><div class="icon-library"></div><a href="../bson.html">bson</a></h2><h2><div class="icon-library"></div><a href="../mongo_dart.html">mongo_dart</a></h2><ul class="icon">
<li><a href="../mongo_dart/Connection.html"><div class="icon-class"></div>Connection</a></li>
<li><div class="icon-class"></div><strong>Cursor</strong></li>
<li><a href="../mongo_dart/Db.html"><div class="icon-class"></div>Db</a></li>
<li><a href="../mongo_dart/DbCollection.html"><div class="icon-class"></div>DbCollection</a></li>
<li><a href="../mongo_dart/DbCommand.html"><div class="icon-class"></div>DbCommand</a></li>
<li><a href="../mongo_dart/GridFS.html"><div class="icon-class"></div>GridFS</a></li>
<li><a href="../mongo_dart/GridFSFile.html"><div class="icon-class"></div>GridFSFile</a></li>
<li><a href="../mongo_dart/GridIn.html"><div class="icon-class"></div>GridIn</a></li>
<li><a href="../mongo_dart/GridOut.html"><div class="icon-class"></div>GridOut</a></li>
<li><a href="../mongo_dart/MapProxy.html"><div class="icon-class"></div>MapProxy&lt;K, V&gt;</a></li>
<li><a href="../mongo_dart/ModifierBuilder.html"><div class="icon-class"></div>ModifierBuilder</a></li>
<li><a href="../mongo_dart/MonadicBlock.html"><div class="icon-interface"></div>MonadicBlock</a></li>
<li><a href="../mongo_dart/MongoGetMoreMessage.html"><div class="icon-class"></div>MongoGetMoreMessage</a></li>
<li><a href="../mongo_dart/MongoInsertMessage.html"><div class="icon-class"></div>MongoInsertMessage</a></li>
<li><a href="../mongo_dart/MongoKillCursorsMessage.html"><div class="icon-class"></div>MongoKillCursorsMessage</a></li>
<li><a href="../mongo_dart/MongoMessage.html"><div class="icon-class"></div>MongoMessage</a></li>
<li><a href="../mongo_dart/MongoQueryMessage.html"><div class="icon-class"></div>MongoQueryMessage</a></li>
<li><a href="../mongo_dart/MongoRemoveMessage.html"><div class="icon-class"></div>MongoRemoveMessage</a></li>
<li><a href="../mongo_dart/MongoReplyMessage.html"><div class="icon-class"></div>MongoReplyMessage</a></li>
<li><a href="../mongo_dart/MongoUpdateMessage.html"><div class="icon-class"></div>MongoUpdateMessage</a></li>
<li><a href="../mongo_dart/SelectorBuilder.html"><div class="icon-class"></div>SelectorBuilder</a></li>
<li><a href="../mongo_dart/ServerConfig.html"><div class="icon-class"></div>ServerConfig</a></li>
</ul>
</div>
<div class="content">
        <h2><strong>Cursor</strong>
          class
        </h2>
        
<button id="show-inherited" class="show-inherited">Hide inherited</button>
<div class="doc">
<pre class="source">
class Cursor{

static const INIT = 0;
static const OPEN = 1;
static const CLOSED = 2;


 int state = INIT;
 int cursorId = 0;
 Db db;
 Queue items;
 DbCollection collection;
 Map selector;
 Map fields;
 int skip = 0;
 int limit = 0;
 Map sort;
 Map hint;
 MonadicBlock eachCallback;
 var eachComplete;
 bool explain;
 int flags = 0;
 Cursor(this.db, this.collection, selectorBuilderOrMap){
   if (selectorBuilderOrMap == null){
     selector = {};
   } else if (selectorBuilderOrMap is SelectorBuilder) {
     selector = selectorBuilderOrMap.map;
     fields = selectorBuilderOrMap.extParams.fields;
     limit = selectorBuilderOrMap.extParams.limit;
     skip = selectorBuilderOrMap.extParams.skip;
   } else if (selectorBuilderOrMap is Map) {
     selector = selectorBuilderOrMap;
   } else {
     throw new ArgumentError('Expected SelectorBuilder or Map, got $selectorBuilderOrMap');
   }

   if (!selector.isEmpty &amp;&amp; !selector.containsKey("query")){
       selector = {"query": selector};
   }
   items = new Queue();
 }
 MongoQueryMessage generateQueryMessage(){
   return new  MongoQueryMessage(collection.fullName(),
           flags,
           skip,
           limit,
           selector,
           fields);
 }
 MongoGetMoreMessage generateGetMoreMessage(){
   return new  MongoGetMoreMessage(collection.fullName(),
           cursorId);
 }


 Map _getNextItem(){
   return items.removeFirst();
 }
 Future&lt;Map&gt; nextObject(){
   if (state == INIT){
     Completer&lt;Map&gt; nextItem = new Completer&lt;Map&gt;();
     MongoQueryMessage qm = generateQueryMessage();
     Future&lt;MongoReplyMessage&gt; reply = db.queryMessage(qm);
     reply.then((replyMessage){
       state = OPEN;
       //print("${replyMessage.cursorId}");
       cursorId = replyMessage.cursorId;
       items.addAll(replyMessage.documents);
       if (items.length &gt; 0){
         Map nextDoc = _getNextItem();
         _log.finer("Cursor _getNextItem $nextDoc");
         nextItem.complete(nextDoc);
       }
       else{
         nextItem.complete(null);
       }
     });
     return nextItem.future;
   }
   else if (state == OPEN &amp;&amp; items.length &gt; 0){
     return new Future.immediate(_getNextItem());
   }
   else if (state == OPEN &amp;&amp; cursorId &gt; 0){
     Completer nextItem = new Completer();
     var qm = generateGetMoreMessage();
     Future&lt;MongoReplyMessage&gt; reply = db.queryMessage(qm);
     reply.then((replyMessage){
       state = OPEN;
       cursorId = replyMessage.cursorId;
       items.addAll(replyMessage.documents);
       if (items.length &gt; 0){
         nextItem.complete(_getNextItem());
       }
       else{
         state = CLOSED;
         nextItem.complete(null);
       }
     });
     return nextItem.future;
   }
   else {
     state = CLOSED;
     return new Future.immediate(null);
   }
 }
 void _nextEach(){
   nextObject().then((val){
     if (val == null){
       eachCallback = null;
       eachComplete.complete(true);
     } else {
       eachCallback(val);
       _nextEach();
     }
   });
 }

 Future&lt;bool&gt; each(MonadicBlock callback){
   eachCallback = callback;
   eachComplete = new Completer();
   _nextEach();
   return eachComplete.future;
 }
 Future&lt;List&lt;Map&gt;&gt; toList(){
   List&lt;Map&gt; result = [];
   Completer completer = new Completer();
   this.each((v)=&gt;result.addLast(v)).then((v)=&gt;completer.complete(result));
   return completer.future;
 }
 Future close(){
   _log.finer("Closing cursor, cursorId = $cursorId");
   state = CLOSED;
   if (cursorId != 0){
     MongoKillCursorsMessage msg = new MongoKillCursorsMessage(cursorId);
     cursorId = 0;
     return db.queryMessage(msg);
   }
 }
}
</pre>
</div>
<div>
<h3>Static Properties</h3>
<div class="field"><h4 id="CLOSED">
<button class="show-code">Code</button>
const         <strong>CLOSED</strong> <a class="anchor-link"
            href="#CLOSED"
            title="Permalink to Cursor.CLOSED">#</a>
        </h4>
        <div class="doc">
<pre class="source">
static const CLOSED = 2;
</pre>
</div>
</div>
<div class="field"><h4 id="INIT">
<button class="show-code">Code</button>
const         <strong>INIT</strong> <a class="anchor-link"
            href="#INIT"
            title="Permalink to Cursor.INIT">#</a>
        </h4>
        <div class="doc">
<pre class="source">
static const INIT = 0;
</pre>
</div>
</div>
<div class="field"><h4 id="OPEN">
<button class="show-code">Code</button>
const         <strong>OPEN</strong> <a class="anchor-link"
            href="#OPEN"
            title="Permalink to Cursor.OPEN">#</a>
        </h4>
        <div class="doc">
<pre class="source">
static const OPEN = 1;
</pre>
</div>
</div>
</div>
<div>
<h3>Constructors</h3>
<div class="method"><h4 id="Cursor">
<button class="show-code">Code</button>
new <strong>Cursor</strong>(<a href="../mongo_dart/Db.html">Db</a> db, <a href="../mongo_dart/DbCollection.html">DbCollection</a> collection, selectorBuilderOrMap) <a class="anchor-link" href="#Cursor"
              title="Permalink to Cursor.Cursor">#</a></h4>
<div class="doc">
<pre class="source">
Cursor(this.db, this.collection, selectorBuilderOrMap){
 if (selectorBuilderOrMap == null){
   selector = {};
 } else if (selectorBuilderOrMap is SelectorBuilder) {
   selector = selectorBuilderOrMap.map;
   fields = selectorBuilderOrMap.extParams.fields;
   limit = selectorBuilderOrMap.extParams.limit;
   skip = selectorBuilderOrMap.extParams.skip;
 } else if (selectorBuilderOrMap is Map) {
   selector = selectorBuilderOrMap;
 } else {
   throw new ArgumentError('Expected SelectorBuilder or Map, got $selectorBuilderOrMap');
 }

 if (!selector.isEmpty &amp;&amp; !selector.containsKey("query")){
     selector = {"query": selector};
 }
 items = new Queue();
}
</pre>
</div>
</div>
</div>
<div>
<h3>Properties</h3>
<div class="field"><h4 id="collection">
<button class="show-code">Code</button>
<a href="../mongo_dart/DbCollection.html">DbCollection</a>         <strong>collection</strong> <a class="anchor-link"
            href="#collection"
            title="Permalink to Cursor.collection">#</a>
        </h4>
        <div class="doc">
<pre class="source">
DbCollection collection;
</pre>
</div>
</div>
<div class="field"><h4 id="cursorId">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/int.html">int</a>         <strong>cursorId</strong> <a class="anchor-link"
            href="#cursorId"
            title="Permalink to Cursor.cursorId">#</a>
        </h4>
        <div class="doc">
<pre class="source">
int cursorId = 0;
</pre>
</div>
</div>
<div class="field"><h4 id="db">
<button class="show-code">Code</button>
<a href="../mongo_dart/Db.html">Db</a>         <strong>db</strong> <a class="anchor-link"
            href="#db"
            title="Permalink to Cursor.db">#</a>
        </h4>
        <div class="doc">
<pre class="source">
Db db;
</pre>
</div>
</div>
<div class="field"><h4 id="eachCallback">
<button class="show-code">Code</button>
<a href="../mongo_dart/MonadicBlock.html">MonadicBlock</a>         <strong>eachCallback</strong> <a class="anchor-link"
            href="#eachCallback"
            title="Permalink to Cursor.eachCallback">#</a>
        </h4>
        <div class="doc">
<pre class="source">
MonadicBlock eachCallback;
</pre>
</div>
</div>
<div class="field"><h4 id="eachComplete">
<button class="show-code">Code</button>
var         <strong>eachComplete</strong> <a class="anchor-link"
            href="#eachComplete"
            title="Permalink to Cursor.eachComplete">#</a>
        </h4>
        <div class="doc">
<pre class="source">
var eachComplete;
</pre>
</div>
</div>
<div class="field"><h4 id="explain">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/bool.html">bool</a>         <strong>explain</strong> <a class="anchor-link"
            href="#explain"
            title="Permalink to Cursor.explain">#</a>
        </h4>
        <div class="doc">
<pre class="source">
bool explain;
</pre>
</div>
</div>
<div class="field"><h4 id="fields">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/Map.html">Map</a>         <strong>fields</strong> <a class="anchor-link"
            href="#fields"
            title="Permalink to Cursor.fields">#</a>
        </h4>
        <div class="doc">
<pre class="source">
Map fields;
</pre>
</div>
</div>
<div class="field"><h4 id="flags">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/int.html">int</a>         <strong>flags</strong> <a class="anchor-link"
            href="#flags"
            title="Permalink to Cursor.flags">#</a>
        </h4>
        <div class="doc">
<pre class="source">
int flags = 0;
</pre>
</div>
</div>
<div class="field"><h4 id="hint">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/Map.html">Map</a>         <strong>hint</strong> <a class="anchor-link"
            href="#hint"
            title="Permalink to Cursor.hint">#</a>
        </h4>
        <div class="doc">
<pre class="source">
Map hint;
</pre>
</div>
</div>
<div class="field"><h4 id="items">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/Queue.html">Queue</a>         <strong>items</strong> <a class="anchor-link"
            href="#items"
            title="Permalink to Cursor.items">#</a>
        </h4>
        <div class="doc">
<pre class="source">
Queue items;
</pre>
</div>
</div>
<div class="field"><h4 id="limit">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/int.html">int</a>         <strong>limit</strong> <a class="anchor-link"
            href="#limit"
            title="Permalink to Cursor.limit">#</a>
        </h4>
        <div class="doc">
<pre class="source">
int limit = 0;
</pre>
</div>
</div>
<div class="field"><h4 id="selector">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/Map.html">Map</a>         <strong>selector</strong> <a class="anchor-link"
            href="#selector"
            title="Permalink to Cursor.selector">#</a>
        </h4>
        <div class="doc">
<pre class="source">
Map selector;
</pre>
</div>
</div>
<div class="field"><h4 id="skip">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/int.html">int</a>         <strong>skip</strong> <a class="anchor-link"
            href="#skip"
            title="Permalink to Cursor.skip">#</a>
        </h4>
        <div class="doc">
<pre class="source">
int skip = 0;
</pre>
</div>
</div>
<div class="field"><h4 id="sort">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/Map.html">Map</a>         <strong>sort</strong> <a class="anchor-link"
            href="#sort"
            title="Permalink to Cursor.sort">#</a>
        </h4>
        <div class="doc">
<pre class="source">
Map sort;
</pre>
</div>
</div>
<div class="field"><h4 id="state">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/int.html">int</a>         <strong>state</strong> <a class="anchor-link"
            href="#state"
            title="Permalink to Cursor.state">#</a>
        </h4>
        <div class="doc">
<pre class="source">
int state = INIT;
</pre>
</div>
</div>
</div>
<div>
<h3>Methods</h3>
<div class="method"><h4 id="close">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/Future.html">Future</a> <strong>close</strong>() <a class="anchor-link" href="#close"
              title="Permalink to Cursor.close">#</a></h4>
<div class="doc">
<pre class="source">
Future close(){
 _log.finer("Closing cursor, cursorId = $cursorId");
 state = CLOSED;
 if (cursorId != 0){
   MongoKillCursorsMessage msg = new MongoKillCursorsMessage(cursorId);
   cursorId = 0;
   return db.queryMessage(msg);
 }
}
</pre>
</div>
</div>
<div class="method"><h4 id="each">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/Future.html">Future</a>&lt;<a href="http://api.dartlang.org/dart_core/bool.html">bool</a>&gt; <strong>each</strong>(<a href="../mongo_dart/MonadicBlock.html">MonadicBlock</a> callback) <a class="anchor-link" href="#each"
              title="Permalink to Cursor.each">#</a></h4>
<div class="doc">
<pre class="source">
Future&lt;bool&gt; each(MonadicBlock callback){
 eachCallback = callback;
 eachComplete = new Completer();
 _nextEach();
 return eachComplete.future;
}
</pre>
</div>
</div>
<div class="method"><h4 id="generateGetMoreMessage">
<button class="show-code">Code</button>
<a href="../mongo_dart/MongoGetMoreMessage.html">MongoGetMoreMessage</a> <strong>generateGetMoreMessage</strong>() <a class="anchor-link" href="#generateGetMoreMessage"
              title="Permalink to Cursor.generateGetMoreMessage">#</a></h4>
<div class="doc">
<pre class="source">
MongoGetMoreMessage generateGetMoreMessage(){
 return new  MongoGetMoreMessage(collection.fullName(),
         cursorId);
}
</pre>
</div>
</div>
<div class="method"><h4 id="generateQueryMessage">
<button class="show-code">Code</button>
<a href="../mongo_dart/MongoQueryMessage.html">MongoQueryMessage</a> <strong>generateQueryMessage</strong>() <a class="anchor-link" href="#generateQueryMessage"
              title="Permalink to Cursor.generateQueryMessage">#</a></h4>
<div class="doc">
<pre class="source">
MongoQueryMessage generateQueryMessage(){
 return new  MongoQueryMessage(collection.fullName(),
         flags,
         skip,
         limit,
         selector,
         fields);
}
</pre>
</div>
</div>
<div class="method"><h4 id="nextObject">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/Future.html">Future</a>&lt;<a href="http://api.dartlang.org/dart_core/Map.html">Map</a>&gt; <strong>nextObject</strong>() <a class="anchor-link" href="#nextObject"
              title="Permalink to Cursor.nextObject">#</a></h4>
<div class="doc">
<pre class="source">
Future&lt;Map&gt; nextObject(){
 if (state == INIT){
   Completer&lt;Map&gt; nextItem = new Completer&lt;Map&gt;();
   MongoQueryMessage qm = generateQueryMessage();
   Future&lt;MongoReplyMessage&gt; reply = db.queryMessage(qm);
   reply.then((replyMessage){
     state = OPEN;
     //print("${replyMessage.cursorId}");
     cursorId = replyMessage.cursorId;
     items.addAll(replyMessage.documents);
     if (items.length &gt; 0){
       Map nextDoc = _getNextItem();
       _log.finer("Cursor _getNextItem $nextDoc");
       nextItem.complete(nextDoc);
     }
     else{
       nextItem.complete(null);
     }
   });
   return nextItem.future;
 }
 else if (state == OPEN &amp;&amp; items.length &gt; 0){
   return new Future.immediate(_getNextItem());
 }
 else if (state == OPEN &amp;&amp; cursorId &gt; 0){
   Completer nextItem = new Completer();
   var qm = generateGetMoreMessage();
   Future&lt;MongoReplyMessage&gt; reply = db.queryMessage(qm);
   reply.then((replyMessage){
     state = OPEN;
     cursorId = replyMessage.cursorId;
     items.addAll(replyMessage.documents);
     if (items.length &gt; 0){
       nextItem.complete(_getNextItem());
     }
     else{
       state = CLOSED;
       nextItem.complete(null);
     }
   });
   return nextItem.future;
 }
 else {
   state = CLOSED;
   return new Future.immediate(null);
 }
}
</pre>
</div>
</div>
<div class="method"><h4 id="toList">
<button class="show-code">Code</button>
<a href="http://api.dartlang.org/dart_core/Future.html">Future</a>&lt;<a href="http://api.dartlang.org/dart_core/List.html">List</a>&lt;<a href="http://api.dartlang.org/dart_core/Map.html">Map</a>&gt;&gt; <strong>toList</strong>() <a class="anchor-link" href="#toList"
              title="Permalink to Cursor.toList">#</a></h4>
<div class="doc">
<pre class="source">
Future&lt;List&lt;Map&gt;&gt; toList(){
 List&lt;Map&gt; result = [];
 Completer completer = new Completer();
 this.each((v)=&gt;result.addLast(v)).then((v)=&gt;completer.complete(result));
 return completer.future;
}
</pre>
</div>
</div>
</div>
        </div>
        <div class="clear"></div>
        </div>
        
        <div class="footer">
          <div>This page was generated at 2012-12-27 12:26:56.038</div>
        </div>
        <script async src="../client-static.js"></script>
        </body></html>
        
